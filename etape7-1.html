<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Étape 7-1 — Le cadenas</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root{
  --muted:#6b7280;
  --accent:#ff6b4a;
  --bg:#fffaf0;
  --card:#ffffff;
  --shadow: rgba(16,24,40,0.06);
  --success:#059669;
}
*{box-sizing:border-box}
body{
  font-family:Inter,system-ui,Arial,sans-serif;
  background:var(--bg);
  margin:0;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
}
.card{
  width:100%;
  max-width:720px;
  background:var(--card);
  border-radius:14px;
  padding:28px;
  box-shadow:0 10px 30px var(--shadow);
  text-align:center;
}
h2{margin:0 0 8px;font-size:22px;color:#1f2937}
p.lead{color:#374151;margin-bottom:18px}

.lock{
  width:120px;height:120px;margin:8px auto 10px;display:block;
  background:linear-gradient(180deg,#fff 0%, #fffaf0 100%);
  border-radius:14px;box-shadow:0 6px 18px rgba(16,24,40,0.06);
  display:flex;align-items:center;justify-content:center;
  position:relative;
  overflow:visible; /* important */
}

.lock svg{ width:72px; height:92px; overflow:visible; display:block; }
.lock .shackle-group{
  transform-box: fill-box;
  transform-origin: 50% 28%;
  transition: transform 520ms cubic-bezier(.2,.9,.3,1), stroke 300ms;
}
.lock.open .shackle-group{
  transform: rotate(-40deg) translate(6px,-10px);
}
.lock.open rect{ stroke: var(--success); }
.lock.open path{ stroke: var(--success); }

.input-row{display:flex;gap:10px;justify-content:center;align-items:center;margin-top:14px}
input.code{
  padding:12px 14px;border-radius:10px;border:1px solid #e6e6e6;font-size:18px;
  width:220px;text-align:center;letter-spacing:6px;
  transition: opacity .28s, transform .28s;
}
.btn{
  margin-top:16px;padding:12px 18px;border-radius:10px;border:0;background:var(--accent);
  color:white;font-weight:700;cursor:pointer;font-size:16px;box-shadow:0 6px 18px rgba(16,24,40,0.06);
}
.btn.ghost{background:transparent;border:1px solid #e6e6e6;color:#333}
.message{margin-top:12px;font-weight:700;min-height:22px}
.success{color:var(--success)}
.error{color:#b91c1c}
#goButton{display:none; opacity:0; transform:translateY(6px) scale(.98); transition: all .36s cubic-bezier(.2,.9,.3,1); }
.fadeIn{opacity:1; transform:translateY(0) scale(1);}
.fadeOut{animation:fadeOut .34s ease forwards}
@keyframes fadeOut{ from{opacity:1; transform:translateY(0)} to{opacity:0; transform:translateY(-8px) scale(.98)} }

.small-note{font-size:13px;color:var(--muted);margin-top:8px}
.hint-note{font-size:14px;color:#374151;margin-top:10px}
</style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="title">
    <h2 id="title">Le cadenas du parc</h2>

    <div class="lock" id="lock" aria-hidden="true">
      <!-- corps du cadenas d'abord (pour que l'anse soit peinte au-dessus) -->
      <svg viewBox="0 0 24 34" preserveAspectRatio="xMidYMid meet" aria-hidden="true" role="img" focusable="false">
        <!-- body first -->
        <rect x="3.5" y="12" width="17" height="10" rx="2" stroke="#ff6b4a" stroke-width="1.6" fill="white"/>
        <!-- shackle after so it sits above the body -->
        <g class="shackle-group">
          <path d="M7 12V8a5 5 0 0 1 10 0v4" stroke="#ff6b4a" stroke-width="1.6" stroke-linecap="round" fill="none"/>
        </g>
      </svg>
    </div>

    <p class="lead">Résous les 4 énigmes pour obtenir le code à 4 chiffres et ouvrir le cadenas.</p>

    <ol id="charadeList" style="text-align:left;max-width:560px;margin:0 auto">
      <li><strong>Chiffre 1 :</strong> Je suis le seul chiffre pair qui est aussi un nombre premier. Qui suis-je ?</li>
      <li><strong>Chiffre 2 :</strong> Je suis le premier chiffre, celui qui représente l'unité, le début de tout. Qui suis-je ?</li>
      <li><strong>Chiffre 3 :</strong> Je suis identique au chiffre précédent. Je me répète. Qui suis-je ?</li>
      <li><strong>Chiffre 4 :</strong> Je suis le vide, le néant, ce qui représente l'absence. Qui suis-je ?</li>
    </ol>

    <div id="inputArea" class="input-row">
      <input class="code" id="codeInput" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="----" aria-label="Code à 4 chiffres">
    </div>

    <div>
      <button id="checkBtn" class="btn">Vérifier le code</button>
      <button id="manualBtn" class="btn ghost" style="display:none">Simuler arrivée</button>
    </div>

    <div class="message" id="message" aria-live="polite"></div>

    <a id="goButton" class="btn" role="button" href="#" rel="noopener" aria-hidden="true">Ouvrir le lien & rejoindre</a>

    <p id="hint" class="hint-note" style="display:none">indice : anniversaire</p>
  </div>

<script>
(function(){
  const CORRECT = "2110";
  const MAP_LINK = "https://maps.app.goo.gl/Jf5tUzWtj2g7nBRh8";
  const TARGET = { lat: 48.8809496, lon: 2.3827609 };
  const RADIUS_METERS = 500; // large radius
  let watchId = null;
  let unlocked = false;
  let attempts = 0;

  const goButton = document.getElementById('goButton');
  const checkBtn = document.getElementById('checkBtn');
  const input = document.getElementById('codeInput');
  const message = document.getElementById('message');
  const manualBtn = document.getElementById('manualBtn');
  const lock = document.getElementById('lock');
  const charadeList = document.getElementById('charadeList');
  const inputArea = document.getElementById('inputArea');
  const hintEl = document.getElementById('hint');

  function showUnlock(){
    unlocked = true;
    // animate hiding charade & input & check button
    charadeList.classList.add('fadeOut');
    inputArea.classList.add('fadeOut');
    checkBtn.classList.add('fadeOut');
    setTimeout(()=> {
      charadeList.style.display = 'none';
      inputArea.style.display = 'none';
      checkBtn.style.display = 'none';
      // open lock visually
      lock.classList.add('open');
      // success message
      message.textContent = "Code correct ! Le lien est prêt.";
      message.className = "message success";
      // show link button
      goButton.href = MAP_LINK;
      goButton.style.display = 'inline-block';
      void goButton.offsetWidth;
      goButton.classList.add('fadeIn');
      goButton.setAttribute('aria-hidden','false');
      // start watch for étape 8 arrival
      startWatchForStep8();
      // reveal manual simulate btn for testing
      manualBtn.style.display = 'inline-block';
    }, 360);
  }

  function showError(){
    attempts++;
    message.textContent = "Code incorrect — réessaie.";
    message.className = "message error";
    if(attempts >= 1){
      hintEl.style.display = 'block';
    }
  }

  checkBtn.addEventListener('click', ()=>{
    const val = (input.value||'').trim();
    if(val === CORRECT){
      showUnlock();
    } else {
      showError();
    }
  });

  function startWatchForStep8(){
    if(!('geolocation' in navigator)) {
      message.textContent += " (géoloc indisponible — utilise le bouton de simulation.)";
      return;
    }
    if(watchId !== null) return;
    watchId = navigator.geolocation.watchPosition(pos=>{
      const d = distanceMeters(pos.coords.latitude,pos.coords.longitude,TARGET.lat,TARGET.lon);
      if(d <= RADIUS_METERS){
        try{ navigator.geolocation.clearWatch(watchId); }catch(e){}
        window.location.href = "etape8.html";
      }
    }, err=>{
      console.warn('geoloc err', err);
    }, { enableHighAccuracy:true, maximumAge:3000, timeout:20000 });
  }

  manualBtn.addEventListener('click', ()=>{
    if(!unlocked){
      message.textContent = "Déverrouille d'abord le cadenas avec le code.";
      message.className = "message error";
      return;
    }
    window.location.href = "etape8.html";
  });

  input.addEventListener('keydown', e=>{
    if(e.key === 'Enter') { e.preventDefault(); checkBtn.click(); }
  });

  function distanceMeters(lat1, lon1, lat2, lon2){
    const R = 6371000;
    const toRad = a => a * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }
})();
</script>
</body>
</html>
