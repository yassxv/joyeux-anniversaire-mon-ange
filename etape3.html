<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Rêvons en grand - Étape 3</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --muted:#6b7280; --accent:#ff6b4a; --bg:#fffaf0;
    --card:#ffffff; --shadow: rgba(16,24,40,0.08);
  }
  *{box-sizing:border-box;}
  body{
    font-family:Inter,system-ui,Arial,sans-serif;
    background:var(--bg);
    margin:0;
    padding:18px;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
  }
  .card{
    width:100%;
    max-width:680px;
    background:var(--card);
    border-radius:16px;
    padding:32px;
    box-shadow:0 15px 35px var(--shadow);
    text-align:center;
    transition: all 0.3s ease;
  }
  h2{
    margin-bottom:20px;
    font-weight:600;
    font-size:26px;
    color:#1f2937;
  }
  p{
    margin-bottom:16px;
    color:#374151;
    line-height:1.6;
  }
  .status{
    margin-top:16px;
    padding:14px;
    border-radius:10px;
    font-weight:600;
    display:block;
    transition: all 0.3s ease;
  }
  .ok{background:#d1fae5;color:#065f46;}
  .bad{background:#fee2e2;color:#991b1b;}
  input[type=text]{
    padding:12px;
    border-radius:10px;
    border:1px solid #ccc;
    width:80%;
    font-size:16px;
    margin-top:12px;
    outline:none;
    transition: border 0.3s;
  }
  input[type=text]:focus{
    border-color:var(--accent);
  }
  button{
    margin-top:16px;
    padding:14px 22px;
    border-radius:10px;
    font-weight:600;
    cursor:pointer;
    border:none;
    background:var(--accent);
    color:white;
    font-size:16px;
    transition: all 0.2s;
  }
  button:hover{opacity:0.9;}
  button.ghost{
    background:transparent;
    border:1px solid #e6e6e6;
    color:#333;
  }
  img.qr{
    max-width:70%;
    margin-top:24px;
    border-radius:14px;
    box-shadow:0 5px 15px rgba(0,0,0,0.1);
  }
  .hidden{display:none;}
</style>
</head>
<body>
  <div class="card">
    <h2>Rendez-vous là où on s’est le plus disputé</h2>
    <p id="distanceText">Vérification de la position...</p>
    <div id="status" class="status"></div>
    
    <!-- Charade -->
    <div id="charadeSection" class="hidden">
      <p><strong>Énigme :</strong> <em> Ne regarde pas que les mots mais aussi ce qui les composent, ainsi que leur symétrique. La voici : <strong> Qv g'zrnv nlm xlvfi </strong> </em></p>
      <input type="text" id="answer" placeholder="Ta réponse..."/>
      <button id="validateBtn">Valider</button>
    </div>

    <!-- QR Code -->
    <div id="qrContainer" class="hidden"></div>

    <!-- Boutons manuels -->
    <button id="manualArrive" class="ghost hidden">Je suis arrivé ici !</button>
    <button id="manualNext" class="ghost hidden">Passer à l’étape suivante</button>
  </div>

<script>
const TARGET_MONTPAR = { lat: 48.8414794, lon: 2.3191836, radius: 60 };
const TARGET_CHAMPS = { lat: 48.870502, lon: 2.304897, radius: 10 };
let geoWatchId = null;
let montparReached = false;
let qrVisible = false;

// Décodage symétrique si nécessaire
function symetricDecode(str){
  const map = {};
  const alphabet = 'abcdefghijklmnopqrstuvwxyz';
  const rev = alphabet.split('').reverse().join('');
  for(let i=0;i<26;i++) map[rev[i]]=alphabet[i];
  let res='';
  for(let c of str.toLowerCase()){
    if(map[c]) res+=map[c];
    else res+=c;
  }
  return res;
}

// Calcul distance
function distanceMeters(lat1, lon1, lat2, lon2){
  const R = 6371000;
  const toRad = a=>a*Math.PI/180;
  const dLat=toRad(lat2-lat1);
  const dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function setStatus(text, cls){
  const s=document.getElementById('status');
  s.textContent=text;
  s.className='status '+(cls||'');
}

function showCharade(){
  document.getElementById('charadeSection').classList.remove('hidden');
}

function showQRCode(){
  if(qrVisible) return;
  const qrContainer=document.getElementById('qrContainer');
  qrContainer.innerHTML=`<p><strong>C’est un peu petit non ?</strong><br>Que dirais-tu de 800 m² rien que pour nous ?</p>
  <img class="qr" src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=https%3A%2F%2Fmaps.app.goo.gl%2FCkjuoNqau5zYmqrNA" alt="QR code secret"/>`;
  qrContainer.classList.remove('hidden');
  qrVisible=true;
}

function hideQRCodeAndNext(){
  const qrContainer=document.getElementById('qrContainer');
  qrContainer.innerHTML='';
  setStatus('Tu es arrivé au 104 avenue des Champs-Élysées ! Étape suivante débloquée.', 'ok');
  setTimeout(()=>{ window.location.href='etape4.html'; },1500);
}

// Boutons manuels
document.getElementById('manualArrive').onclick=function(){
  montparReached=true;
  setStatus('Position confirmée manuellement.', 'ok');
  showCharade();
  this.classList.add('hidden');
};
document.getElementById('manualNext').onclick=function(){
  hideQRCodeAndNext();
  this.classList.add('hidden');
};

// Validation charade
document.getElementById('validateBtn').onclick=function(){
  const answer=document.getElementById('answer').value.trim().toLowerCase();
  if(answer==='je t\'aime mon coeur'){
    setStatus('Bonne réponse !', 'ok');
    showQRCode();
    document.getElementById('manualNext').classList.remove('hidden');
  } else {
    setStatus('Réessaie !', 'bad');
  }
};

// Géolocalisation
if('geolocation' in navigator){
  geoWatchId=navigator.geolocation.watchPosition(pos=>{
    const dMontpar=distanceMeters(pos.coords.latitude,pos.coords.longitude,TARGET_MONTPAR.lat,TARGET_MONTPAR.lon);
    const dChamps=distanceMeters(pos.coords.latitude,pos.coords.longitude,TARGET_CHAMPS.lat,TARGET_CHAMPS.lon);

    if(!montparReached && dMontpar<=TARGET_MONTPAR.radius){
      montparReached=true;
      setStatus('Tu es arrivé à Montparnasse !', 'ok');
      showCharade();
    } else if(!montparReached){
      setStatus(`Tu es à ${Math.round(dMontpar)} m du lieu de rendez-vous.`, '');
      document.getElementById('manualArrive').classList.remove('hidden');
    }

    if(qrVisible && dChamps<=TARGET_CHAMPS.radius){
      hideQRCodeAndNext();
    }

  }, err=>{
    setStatus('Erreur localisation. Utilise les boutons manuels.', 'bad');
    document.getElementById('manualArrive').classList.remove('hidden');
    document.getElementById('manualNext').classList.remove('hidden');
  }, {enableHighAccuracy:true, maximumAge:3000, timeout:20000});
}else{
  setStatus('Ton appareil ne supporte pas la géolocalisation.', 'bad');
  document.getElementById('manualArrive').classList.remove('hidden');
  document.getElementById('manualNext').classList.remove('hidden');
}
</script>
</body>
</html>
